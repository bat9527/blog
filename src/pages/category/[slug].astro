---
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import RightPanel from '../../components/RightPanel.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const categories = [
    { slug: 'tech', name: '科技' },
    { slug: 'investment', name: '投资' },
    { slug: 'economy', name: '经济' },
    { slug: 'humanities', name: '人文' },
    { slug: 'english', name: '英语' },
    { slug: 'original', name: '原创' },
    { slug: 'others', name: '其他' },
  ];

  return categories.map(category => ({
    params: { slug: category.slug },
    props: { categoryName: category.name },
  }));
}

const { categoryName } = Astro.props;
const { slug } = Astro.params;

const allPosts = await getCollection('blog');
const filteredPosts = allPosts.filter(post => post.data.category === categoryName);

const sortedPosts = filteredPosts.sort((a, b) => {
  // Sort by featured first, then by claps
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return b.data.claps - a.data.claps;
});

const categories = [
  { slug: 'tech', name: '科技' },
  { slug: 'investment', name: '投资' },
  { slug: 'economy', name: '经济' },
  { slug: 'humanities', name: '人文' },
  { slug: 'english', name: '英语' },
  { slug: 'original', name: '原创' },
  { slug: 'others', name: '其他' },
];
---

<Layout title={`Andy Blog - ${categoryName}`}>
<div class="flex min-h-screen bg-white overflow-x-hidden md:h-screen md:overflow-hidden">
    <Sidebar activeTab="home" />
    
    <main class="flex-1 border-r border-gray-100 min-h-screen relative overflow-x-hidden md:h-full md:overflow-y-auto md:ml-[280px]">
      <div class="w-[90%] md:max-w-[720px] mx-auto pt-6 md:pt-10 min-h-screen pb-20">

        <!-- Mobile Header -->
        <div class="md:hidden flex items-center justify-between mb-4 px-4">
          <div class="font-serif font-bold text-2xl tracking-tight">Andy Blog</div>
          <div class="flex gap-3 items-center">
            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <img src={`${import.meta.env.BASE_URL.replace(/\/$/, '')}/images/avatar.jpg`} class="w-8 h-8 rounded-full" alt="User" />
          </div>
        </div>

        <!-- Category Tabs -->
        <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 border-b border-gray-100 px-4 md:px-0 overflow-x-auto no-scrollbar">
          <div class="flex items-center gap-6 md:gap-8 min-w-max">
            <a 
              href={`${import.meta.env.BASE_URL}`}
              class="py-3 md:py-4 text-sm font-medium text-gray-500 hover:text-gray-900 transition-colors relative whitespace-nowrap"
            >
              全部
            </a>
            
            {categories.map(cat => (
              <a 
                href={`${import.meta.env.BASE_URL.replace(/\/$/, '')}/category/${cat.slug}`}
                class={`py-3 md:py-4 text-sm font-medium relative whitespace-nowrap transition-colors ${
                  slug === cat.slug 
                    ? 'text-gray-900' 
                    : 'text-gray-500 hover:text-gray-900'
                }`}
              >
                {cat.name}
                {slug === cat.slug && (
                  <div class="absolute bottom-0 left-0 w-full h-[1px] bg-gray-900"></div>
                )}
              </a>
            ))}
          </div>
        </div>

        <!-- Feed List -->
        <div class="mt-2 px-4 md:px-0">
          {sortedPosts.length > 0 ? (
            sortedPosts.map(post => (
              <ArticleCard 
                id={post.slug}
                title={post.data.title}
                subtitle={post.data.subtitle}
                publishedAt={post.data.publishedAt}
                readTime={post.data.readTime}
                tags={post.data.tags}

                thumbnailUrl={post.data.thumbnailUrl}
              />
            ))
          ) : (
             <div class="py-20 text-center text-gray-500">
                <p>暂无相关文章</p>
             </div>
          )}
          
          {sortedPosts.length > 0 && (
            <div class="py-10 text-center text-gray-500 text-sm">
              You're all caught up.
            </div>
          )}
        </div>

        <!-- Mobile Create Button -->
        <div class="md:hidden fixed bottom-8 right-4 z-30">
          <button class="bg-green-600 text-white p-3.5 rounded-full shadow-lg hover:bg-green-700 active:scale-95 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
            </svg>
          </button>
        </div>
      </div>
    </main>

    <RightPanel />
  </div>
</Layout>
